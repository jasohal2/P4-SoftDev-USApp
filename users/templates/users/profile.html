{% extends "base.html" %} {% load review_extras %} {% block content %}
<div class="page-wrapper">
  <div class="profile-wrapper">
    {% if user.is_authenticated and user == profile_user %}
    <h2>My Profile</h2>
    <div class="profile-info">
      <p><b>Name:</b> {{ profile_user.full_name }}</p>
      <p><b>Email:</b> {{ profile_user.email }}</p>
    </div>
    {% else %}
    <h2>{{ profile_user.full_name }}'s Profile</h2>
    <div class="profile-info other">
      <p><b>Name:</b> {{ profile_user.full_name }}</p>
      {% if user.is_authenticated %}
      <form
        method="post"
        action=""
        {%
        if
        is_following
        %}onsubmit="return confirm('Unfollow {{ profile_user.username }}?');"
        {%
        endif
        %}
      >
        {% csrf_token %} {% if is_following %}
        <button type="submit">Unfollow</button>
        {% else %}
        <button type="submit">Follow</button>
        {% endif %}
      </form>
      {% endif %}
    </div>
    {% endif %}

    <div
      class="profile-follow {% if profile_user.following.count > 5 %}scrollable{% endif %}"
    >
      <h3>Following: {{ profile_user.following.count }}</h3>
      {% for f in profile_user.following.all %}
      <div class="follow-row">
        <a href="{% url 'user_profile' f.username %}">
          <span class="follow-user">{{ f.full_name }} ({{ f.username }})</span>
        </a>
        {% if user.is_authenticated and user == profile_user %}
        <form
          method="post"
          action=""
          class="unfollow-inline-form"
          onsubmit="return confirm('Unfollow {{ f.username }}?');"
        >
          {% csrf_token %}
          <input
            type="hidden"
            name="unfollow_username"
            value="{{ f.username }}"
          />
          <button
            type="submit"
            class="btn-unfollow"
            aria-label="Unfollow {{ f.username }}"
          >
            Unfollow
          </button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <div
      class="profile-follow {% if profile_user.followers.count > 5 %}scrollable{% endif %}"
    >
      <h3>Followers: {{ profile_user.followers.count }}</h3>
      {% for follower in profile_user.followers.all %}
      <div class="follow-row">
        <a href="{% url 'user_profile' follower.username %}">
          <span class="follow-user"
            >{{ follower.full_name }} ({{ follower.username }})</span
          >
        </a>
        <!-- Follow-back / unfollow controls (exclude self) -->
        {% if user.is_authenticated and user == profile_user and follower != user %}
          {% if follower.id in following_ids %}
            <form
              method="post"
              action=""
              class="unfollow-inline-form"
              onsubmit="return confirm('Unfollow {{ follower.username }}?');"
            >
              {% csrf_token %}
              <input type="hidden" name="unfollow_username" value="{{ follower.username }}" />
              <button
                type="submit"
                class="btn-unfollow"
                aria-label="Unfollow {{ follower.username }}"
              >Unfollow</button>
            </form>
          {% else %}
            <form method="post" action="" class="follow-inline-form">
              {% csrf_token %}
              <input type="hidden" name="follow_username" value="{{ follower.username }}" />
              <button
                type="submit"
                class="btn-follow"
                aria-label="Follow {{ follower.username }}"
              >Follow</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% if user.is_authenticated and user == profile_user %}
    <div class="user-search-block">
      <h3>Find Users</h3>
      <form method="get" action="" class="user-search-form">
        <input
          type="text"
          name="user_query"
          value="{{ user_search_query }}"
          placeholder="Search by username or name"
          aria-label="User search"
        />
        <button type="submit" class="btn">Search</button>
        {% if user_search_query %}
        <a href="?" class="btn" style="background: #666">Clear</a>
        {% endif %}
      </form>
      {% if user_search_query %}
      <p class="user-search-summary">
        Results for "{{ user_search_query }}" ({{ user_search_results|length }})
      </p>
      {% endif %} {% if user_search_results %}
      <ul class="user-search-results">
        {% for u in user_search_results %}
        <li class="user-search-result-item">
          <a href="{% url 'user_profile' u.username %}"
            ><strong>{{ u.username }}</strong></a
          >
          <span class="user-search-name">{{ u.full_name }}</span>
          {% if u.id in following_ids %}
          <form
            method="post"
            action=""
            class="inline-form"
            onsubmit="return confirm('Unfollow {{ u.username }}?');"
          >
            {% csrf_token %}
            <input
              type="hidden"
              name="unfollow_username"
              value="{{ u.username }}"
            />
            <button
              type="submit"
              class="btn-unfollow"
              aria-label="Unfollow {{ u.username }}"
            >
              Unfollow
            </button>
          </form>
          {% else %}
          <form method="post" action="" class="inline-form">
            {% csrf_token %}
            <input
              type="hidden"
              name="follow_username"
              value="{{ u.username }}"
            />
            <button
              type="submit"
              class="btn-follow"
              aria-label="Follow {{ u.username }}"
            >
              Follow
            </button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% elif user_search_query %}
      <p>No users found.</p>
      {% endif %}
    </div>
    <h2>My Reviews</h2>
    {% else %}
    <h3>{{ profile_user.full_name }}'s Reviews</h3>
    {% endif %}
    <ul>
      {% for review in reviews %}
      <li class="profile-reviews_item">
        {% if review.book.image %}
        <img
          src="{{ review.book.image.url }}"
          class="profile-reviews_img"
          alt="{{ review.book.title }} cover"
        />
        {% else %}
        <div class="profile-reviews_img placeholder" aria-hidden="true"></div>
        {% endif %}
        <div class="profile-reviews_item-description">
          <a 
          href="{% url 'book_detail' review.book.id %}"
          class="profile-reviews_item-book-link"
            >{{ review.book.title }}</a
          >
          <h3 class="profile-reviews_item-headline">
            <span class="profile-reviews_item-headline-text"
              >{{ review.headline }}</span
            >
            <span
              class="book-rating"
              aria-label="Rating: {{ review.rating }} out of 5"
            >
              {% render_stars review.rating %}
            </span>
          </h3>
          <p class="profile-reviews_item-body" id="review-body-{{ review.id }}">
            {{ review.body }}
          </p>
          {% if user.is_authenticated and user == profile_user %}
          <div class="profile-review_links">
            <a
              class="profile-review_link-direct"
              href="{% url 'book_detail' review.book.id %}#review-{{ review.id }}"
              >Read full review →</a
            >
            <div class="profile-review_links-btns">
              <a
                class="profile-review_link-btn"
                href="{% url 'review_edit' review.book.id review.id %}"
                >Edit Review
                <svg class="icon icon-pencil" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25ZM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/>
                </svg>
              </a>
              <form method="post" action="{% url 'review_delete' review.book.id review.id %}" class="inline-delete-form">
                {% csrf_token %}
                <button type="submit" class="profile-review_link-btn danger" data-confirm-delete data-item-label="the review '{{ review.headline|escape }}'">
                  Delete Review
                  <svg class="icon icon-trash" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12Zm3.46-7.12 1.41-1.41L12 12.59l1.12-1.12 1.41 1.41L13.41 14l1.12 1.12-1.41 1.41L12 15.41l-1.12 1.12-1.41-1.41L10.59 14l-1.13-1.12ZM15.5 4l-1-1h-5l-1 1H5v2h14V4h-3.5Z"/>
                  </svg>
                </button>
              </form>
            </div>
          </div>
          <p class="profile-reviews_item-info">
            {% if forloop.first %}
              New review posted on {{ review.created|date:"M j, Y \\a\\t g:i A" }}
            {% else %}
              Review posted on {{ review.created|date:"M j, Y \\a\\t g:i A" }}
            {% endif %}
          </p>
          {% else %}
          <div class="profile-review_links">
            <a
              class="profile-review_link-direct"
              href="{% url 'book_detail' review.book.id %}#review-{{ review.id }}"
              >Read full review →</a
            >
          </div>
          <p class="profile-reviews_item-info">
            {% if forloop.first %}
              New review by
              <a href="{% url 'user_profile' review.user.username %}">{{ review.user.username }}</a>
              on {{ review.created|date:"M j, Y \\a\\t g:i A" }}
            {% else %}
              Review by
              <a href="{% url 'user_profile' review.user.username %}">{{ review.user.username }}</a>
              on {{ review.created|date:"M j, Y \\a\\t g:i A" }}
            {% endif %}
          </p>
          {% endif %}
        </div>
      </li>
      {% empty %}
      <li>No reviews yet.</li>
      {% endfor %}
    </ul>
  </div>
  <p>
    <a href="{% url 'home' %}" class="btn btn-ghost home-btn">
      <svg class="icon icon-home" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8Z"/></svg>
      Home
    </a>
  </p>
  <br />
  <br />
</div>

{% endblock content %} {% block extra_scripts %}{% endblock extra_scripts %}
